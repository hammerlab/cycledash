setup: |
    gulp prod
    ./tests/pdifftests/create-test-db.sh
    ./tests/pdifftests/start-cycledash.sh

waitFor:
    url: http://localhost:5001/about
    timeout_secs: 30

aliases:
  - &std-config
      viewportSize:
        width: 1280
        height: 800
      injectCss: |
        body {
          background-color: white;
        }

tests:
  # We use setTimeout(..., 250) to give the page a chance to finish its
  # XHR. Ideally, we could wait on an element to show up, instead of hackily
  # waiting 250ms.
  - name: examine
    description: Initial view of a fully-loaded Examine page.
    url: http://localhost:5001/runs/1/examine
    config:
      <<: *std-config

  - name: examine-sorted
    description: Examine page sorted by decreasing Normal Read Depth
    url: http://localhost:5001/runs/1/examine
    config:
      <<: *std-config
      injectJs: |
        c = document.createEvent('MouseEvent');
        c.initMouseEvent('click', true, true, window);
        $('[data-attribute="sample:RD"] a').get(0).dispatchEvent(c);

  - name: examine-tooltip
    description: Examine page showing a Normal Read Depth tooltip
    url: http://localhost:5001/runs/1/examine
    config:
      <<: *std-config
      injectJs: |
        setTimeout(function() {
          $('[data-attribute="sample:RD"] .tooltip').show();
        }, 250);

  - name: examine-filter
    description: Examine page showing a filtered view
    # CQL: sample_name = NORMAL AND info:DP > 50 ORDER BY info:DP, sample:RD DESC
    url: http://localhost:5001/runs/1/examine?query=sample_name+%3D+NORMAL+AND+info%3ADP+%3E+50+ORDER+BY+info%3ADP%2C+sample%3ARD+DESC
    config:
      <<: *std-config

  - name: examine-comments-view
    description: Examine page showing a comment in view mode.
    url: http://localhost:5001/runs/1/examine
    config:
      <<: *std-config
      injectJs: |
        setTimeout(function() {
          c = document.createEvent('MouseEvent');
          c.initMouseEvent('click', true, true, window);
          $('.vcf-table').find('tbody').find('tr:first').get(0).dispatchEvent(c)
        }, 250);

  - name: examine-comments-edit
    description: Examine page showing a comment in edit mode.
    url: http://localhost:5001/runs/1/examine
    config:
      <<: *std-config
      injectJs: |
        setTimeout(function() {
          c = document.createEvent('MouseEvent');
          c.initMouseEvent('click', true, true, window);
          $('[class="vcf-table"]').find('tbody').find('tr:first').get(0).dispatchEvent(c)
          $('[class="variant-info"]').find('button:contains("Edit")').get(0).dispatchEvent(c)
        }, 250);

  - name: examine-bad-query
    description: Examine page showing a poorly formed query
    url: http://localhost:5001/runs/1/examine
    config:
      <<: *std-config
      injectJs: |
        setTimeout(function() {
          q = $('.query-status').first();
          q.removeClass('good');
          q.addClass('bad');
        }, 250);

  - name: runs
    description: Initial view of the runs page
    url: http://localhost:5001/
    config:
      <<: *std-config

  - name: runs-info
    description: Showing an expanded run row and information
    url: http://localhost:5001/
    config:
      <<: *std-config
      injectJs: |
        setTimeout(function() {
          c = document.createEvent('MouseEvent');
          c.initMouseEvent('click', true, true, window);
          $('tr.run').get(0).dispatchEvent(c);
        }, 250);

  - name: validated-run
    description: Examine page showing a run with associated validation data.
    url: http://localhost:5001/runs/2/examine
    config:
      <<: *std-config

  - name: validated-run-with-filter
    description: Same as "validated-run", but with a filter applied.
    # CQL: reference = G ORDER BY contig, position
    url: http://localhost:5001/runs/2/examine?query=reference+%3D+G+ORDER+BY+contig%2C+position
    config:
      <<: *std-config

  - name: comments
    description: Initial view of the comments page
    url: http://localhost:5001/comments
    config:
      <<: *std-config
